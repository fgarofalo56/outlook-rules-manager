# Security Scanning Workflow
# Comprehensive security scanning for credentials, secrets, PII, and code quality
#
# Scans for:
# - Hardcoded credentials and secrets
# - Azure tenant/client IDs
# - Email addresses and personal information
# - PowerShell security issues
# - Common vulnerability patterns

name: üîí Security Scan

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  schedule:
    # Run weekly on Sundays at midnight
    - cron: '0 0 * * 0'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

env:
  # Patterns that should NEVER appear in committed code
  BLOCKED_PATTERNS: |
    @microsoft\.com
    @limitlessdata\.ai
    @housegarofalo\.com

jobs:
  # ============================================
  # SECRET DETECTION - Gitleaks with custom config
  # ============================================
  secret-scan:
    name: üîê Secret Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks with custom config
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_CONFIG: .gitleaks.toml
        continue-on-error: false

  # ============================================
  # PII DETECTION - Personal Information
  # ============================================
  pii-scan:
    name: üîç PII Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for email addresses
        run: |
          echo "üîç Scanning for email addresses..."

          # Patterns to block (real email domains)
          BLOCKED_DOMAINS=(
            "microsoft.com"
            "limitlessdata.ai"
            "housegarofalo.com"
            "outlook.com"
            "hotmail.com"
            "live.com"
            "gmail.com"
          )

          # Allowed example domains
          ALLOWED_DOMAINS=(
            "example.com"
            "company.com"
            "domain.com"
            "contoso.com"
            "fabrikam.com"
          )

          FOUND_PII=0

          for domain in "${BLOCKED_DOMAINS[@]}"; do
            echo "Checking for @$domain..."
            # Search in code files, exclude example files and docs
            MATCHES=$(grep -rn "@$domain" --include="*.ps1" --include="*.json" . 2>/dev/null | grep -v "example" | grep -v "SECURITY-QUESTIONNAIRE" | grep -v "\.md:" || true)
            if [ -n "$MATCHES" ]; then
              echo "‚ùå BLOCKED: Found @$domain email(s):"
              echo "$MATCHES"
              FOUND_PII=1
            fi
          done

          if [ $FOUND_PII -eq 1 ]; then
            echo ""
            echo "::error::PII DETECTED - Email addresses found in code!"
            echo "::error::Please remove personal email addresses before committing."
            exit 1
          else
            echo "‚úÖ No blocked email domains found"
          fi

      - name: Check for Azure GUIDs in code
        run: |
          echo "üîç Scanning for Azure GUIDs..."

          GUID_PATTERN='[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}'
          PLACEHOLDER_GUID='00000000-0000-0000-0000-000000000000'

          FOUND_GUIDS=0

          # Check PowerShell files for GUIDs (excluding placeholder)
          echo "Checking .ps1 files..."
          for file in $(find . -name "*.ps1" -type f); do
            MATCHES=$(grep -nE "$GUID_PATTERN" "$file" 2>/dev/null | grep -v "$PLACEHOLDER_GUID" | grep -v "example" || true)
            if [ -n "$MATCHES" ]; then
              echo "‚ö†Ô∏è WARNING: GUID found in $file:"
              echo "$MATCHES"
              # Don't fail for now, just warn
            fi
          done

          # Check JSON files (but not example files)
          echo "Checking .json files..."
          for file in $(find . -name "*.json" -type f | grep -v "example"); do
            # Skip if file doesn't exist
            [ -f "$file" ] || continue
            MATCHES=$(grep -nE "$GUID_PATTERN" "$file" 2>/dev/null | grep -v "$PLACEHOLDER_GUID" || true)
            if [ -n "$MATCHES" ]; then
              echo "‚ùå BLOCKED: GUID found in $file:"
              echo "$MATCHES"
              FOUND_GUIDS=1
            fi
          done

          if [ $FOUND_GUIDS -eq 1 ]; then
            echo ""
            echo "::error::Azure GUIDs (Tenant/Client IDs) detected in tracked files!"
            echo "::error::Please use placeholder GUIDs or move to .env files."
            exit 1
          else
            echo "‚úÖ No exposed Azure GUIDs found"
          fi

      - name: Check for blocked files
        run: |
          echo "üîç Checking for files that should not be committed..."

          BLOCKED_FILES=(
            ".env"
            "app-config.json"
            "rules-config.json"
            "demo.env"
          )

          FOUND_BLOCKED=0

          for file in "${BLOCKED_FILES[@]}"; do
            if git ls-files --error-unmatch "$file" 2>/dev/null; then
              echo "‚ùå BLOCKED: $file is tracked in git!"
              FOUND_BLOCKED=1
            fi
          done

          if [ $FOUND_BLOCKED -eq 1 ]; then
            echo ""
            echo "::error::Sensitive files detected in repository!"
            echo "::error::Remove with: git rm --cached <filename>"
            exit 1
          else
            echo "‚úÖ No blocked files found in repository"
          fi

  # ============================================
  # POWERSHELL SECURITY ANALYSIS
  # ============================================
  powershell-analysis:
    name: üìú PSScriptAnalyzer
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run PSScriptAnalyzer
        shell: pwsh
        run: |
          # Install PSScriptAnalyzer
          if (-not (Get-Module -ListAvailable -Name PSScriptAnalyzer)) {
            Install-Module PSScriptAnalyzer -Force -Scope CurrentUser
          }

          Write-Host "üîç Running PSScriptAnalyzer..." -ForegroundColor Cyan

          # Run analysis on all PowerShell files
          $results = Get-ChildItem -Path . -Include *.ps1,*.psm1,*.psd1 -Recurse |
            ForEach-Object {
              Invoke-ScriptAnalyzer -Path $_.FullName -Severity Warning,Error -ReportSummary
            }

          # Output results
          if ($results) {
            $results | Format-Table -AutoSize

            # Count errors
            $errors = $results | Where-Object { $_.Severity -eq 'Error' }
            if ($errors.Count -gt 0) {
              Write-Error "‚ùå Found $($errors.Count) error(s) in PowerShell scripts"
              exit 1
            } else {
              Write-Host "‚ö†Ô∏è Found $($results.Count) warning(s)" -ForegroundColor Yellow
            }
          } else {
            Write-Host "‚úÖ No issues found!" -ForegroundColor Green
          }

      - name: Check for hardcoded values
        shell: pwsh
        run: |
          Write-Host "üîç Checking for hardcoded sensitive values..." -ForegroundColor Cyan

          $patterns = @{
            "Hardcoded GUID" = '[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}'
            "Email Address" = '[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.(com|org|net|io)'
            "Client Secret" = 'client.*secret.*=.*[A-Za-z0-9~._-]{20,}'
          }

          $issues = @()

          foreach ($file in Get-ChildItem -Path . -Include *.ps1 -Recurse) {
            $content = Get-Content $file.FullName -Raw

            foreach ($patternName in $patterns.Keys) {
              $matches = [regex]::Matches($content, $patterns[$patternName])
              foreach ($match in $matches) {
                # Skip placeholder values
                if ($match.Value -notmatch '00000000-0000-0000-0000-000000000000' -and
                    $match.Value -notmatch 'example\.com' -and
                    $match.Value -notmatch 'contoso\.com' -and
                    $match.Value -notmatch 'company\.com') {
                  $issues += [PSCustomObject]@{
                    File = $file.Name
                    Pattern = $patternName
                    Value = $match.Value.Substring(0, [Math]::Min(50, $match.Value.Length)) + "..."
                  }
                }
              }
            }
          }

          if ($issues.Count -gt 0) {
            Write-Host "‚ö†Ô∏è Potential sensitive values found:" -ForegroundColor Yellow
            $issues | Format-Table -AutoSize
            Write-Host "Please review these findings." -ForegroundColor Yellow
          } else {
            Write-Host "‚úÖ No hardcoded sensitive values detected" -ForegroundColor Green
          }

      - name: Generate analysis report
        if: always()
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path sarif-results -Force | Out-Null

          $results = Get-ChildItem -Path . -Include *.ps1,*.psm1,*.psd1 -Recurse |
            ForEach-Object {
              Invoke-ScriptAnalyzer -Path $_.FullName -Severity Information,Warning,Error
            }

          $results | ConvertTo-Json -Depth 5 | Set-Content -Path sarif-results/psscriptanalyzer-results.json

      - name: Upload analysis results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-scan-results
          path: sarif-results/
          retention-days: 30

  # ============================================
  # DEPENDENCY REVIEW (for PRs)
  # ============================================
  dependency-review:
    name: üì¶ Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        continue-on-error: true

  # ============================================
  # SUMMARY JOB
  # ============================================
  security-summary:
    name: üìä Security Summary
    runs-on: ubuntu-latest
    needs: [secret-scan, pii-scan, powershell-analysis]
    if: always()
    steps:
      - name: Check results
        run: |
          echo "## üîí Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.secret-scan.result }}" == "success" ]; then
            echo "‚úÖ Secret Detection: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Secret Detection: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.pii-scan.result }}" == "success" ]; then
            echo "‚úÖ PII Detection: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå PII Detection: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.powershell-analysis.result }}" == "success" ]; then
            echo "‚úÖ PowerShell Analysis: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå PowerShell Analysis: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "For details, check individual job logs." >> $GITHUB_STEP_SUMMARY

          # Fail if any critical job failed
          if [ "${{ needs.secret-scan.result }}" == "failure" ] || [ "${{ needs.pii-scan.result }}" == "failure" ]; then
            echo "::error::Security scan failed - credentials or PII detected!"
            exit 1
          fi
